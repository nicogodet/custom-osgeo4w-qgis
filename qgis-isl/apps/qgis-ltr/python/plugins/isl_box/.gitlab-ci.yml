stages:
  - 🐍 lint
  - 📦 build
  - 🚀 deploy

# Change pip's cache directory to be inside the project directory since we can
# only cache local items.
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PROJECT: "isl_box"

# Pip's cache doesn't store the python packages
# https://pip.pypa.io/en/stable/reference/pip_install/#caching
#
# If you want to also cache the installed packages, you have to install
# them in a virtualenv and cache it as well.
cache:
  paths:
    - .cache/pip

flake8:
  stage: 🐍 lint
  image: python:3.9
  before_script:
    - python3 -m pip install flake8
  script:
    - flake8 .

pylint:
  stage: 🐍 lint
  image: python:3.9
  allow_failure: true
  before_script:
    - python3 -m pip install pylint
  script:
    - pylint --rcfile=pylintrc *.py algorithm/*.py algorithm/acb_amc/*.py

builder:
  stage: 📦 build
  image: python:3.9-buster
  before_script:
    - apt-get update
    - apt-get install -y make zip
    - python3 -m pip install pyqt5-tools
  script:
    - make zip
  artifacts:
    expose_as: "Latest packaged plugin version"
    name: "$PROJECT_DIR_b$CI_COMMIT_REF_NAME-c$CI_COMMIT_SHORT_SHA-j$CI_JOB_ID"
    public: true
    paths:
      - isl_box.zip

release-from-tag:
  stage: 🚀 deploy
  image: alpine
  only:
    - tags
  except:
    - branches
  needs:
    - builder
  before_script:
    - apk add openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - scp -P"$SSH_PORT" -o StrictHostKeyChecking=no isl_box.zip nico@"$SSH_IP":/home/nico/QGISrepo_plugins/
